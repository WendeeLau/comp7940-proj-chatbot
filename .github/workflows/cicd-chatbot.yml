name: deploy to render and build image 

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Docker image build and push
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/comp7940-chatbot-yumbuddy:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/your-repo-name:${{ github.sha }}

      # Render deploy
      - name: Trigger Render Deployment
        run: |
          DEPLOY_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deployments")
          
          if [ "$DEPLOY_RESPONSE" -ne 201 ]; then
            echo "::error::Render deployment failed with status code: $DEPLOY_RESPONSE"
            exit 1
          fi

      # Telegram notice
      - name: Send Telegram Notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            EMOJI="✅"
            STATUS="succeeded"
          else
            EMOJI="❌"
            STATUS="failed"
          fi

          MESSAGE="$EMOJI CI/CD Pipeline $STATUS
          - Repository: ${{ github.repository }}
          - Commit: ${{ github.sha }}
          - Workflow: ${{ github.workflow }}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"
